<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Swiss German Practice - Verbs & Numbers</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #FF0000 0%, #FFFFFF 50%, #FF0000 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            position: relative;
            overflow: auto;
        }

        body::before {
            content: 'üèîÔ∏è ‚õ∞Ô∏è üèîÔ∏è ‚õ∞Ô∏è üèîÔ∏è';
            position: fixed;
            bottom: 10px;
            left: 0;
            right: 0;
            font-size: 3em;
            text-align: center;
            opacity: 0.25;
            pointer-events: none;
            z-index: 0;
        }

        .container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 900px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            position: relative;
            z-index: 1;
        }

        h1 {
            text-align: center;
            color: #FF0000;
            margin-bottom: 10px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1em;
        }

        .verb-title {
            text-align: center;
            font-size: 2em;
            color: #FF0000;
            margin-bottom: 30px;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }

        .game-container {
            display: flex;
            gap: 40px;
            justify-content: center;
            margin-bottom: 30px;
        }

        .column {
            flex: 1;
            max-width: 300px;
        }

        .column.full-width {
            max-width: 100%;
            width: 100%;
        }

        .column h2 {
            text-align: center;
            color: #FF0000;
            margin-bottom: 20px;
            font-size: 1.3em;
        }

        .item {
            background: #f8f9fa;
            padding: 15px 20px;
            margin-bottom: 12px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 3px solid transparent;
            font-size: 1.1em;
            text-align: center;
        }

        .item:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }

        .item.selected {
            border-color: #FF0000;
            background: #ffe6e6;
            font-weight: bold;
        }

        .item.correct {
            border-color: #28a745;
            background: #d4edda;
            animation: correctPulse 0.5s ease;
        }

        .item.incorrect {
            border-color: #dc3545;
            background: #f8d7da;
            animation: shake 0.5s ease;
        }

        .item.matched {
            opacity: 0.4;
            cursor: not-allowed;
            pointer-events: none;
        }

        @keyframes correctPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        .controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }

        button {
            background: #FF0000;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        button:hover {
            background: #CC0000;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 0, 0, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        .score {
            text-align: center;
            font-size: 1.3em;
            color: #FF0000;
            margin-bottom: 20px;
            font-weight: bold;
        }

        .message {
            text-align: center;
            font-size: 1.2em;
            margin-top: 20px;
            min-height: 30px;
            font-weight: bold;
        }

        .message.success {
            color: #28a745;
        }

        .message.error {
            color: #dc3545;
        }

        .loading {
            text-align: center;
            color: #666;
            font-size: 1.2em;
        }

        .stats {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .stat-box {
            background: #f8f9fa;
            padding: 10px 20px;
            border-radius: 10px;
            border: 2px solid #FF0000;
        }

        .stat-label {
            font-size: 0.8em;
            color: #666;
        }

        .stat-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #FF0000;
        }

        .mode-selector {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 20px;
        }

        .mode-btn {
            background: white;
            color: #FF0000;
            border: 2px solid #FF0000;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
        }

        .mode-btn.active {
            background: #FF0000;
            color: white;
        }

        .mode-btn:hover {
            transform: scale(1.05);
        }

        .confetti {
            position: fixed;
            font-size: 2em;
            animation: fall 3s linear;
            pointer-events: none;
            z-index: 1000;
        }

        @keyframes fall {
            to {
                transform: translateY(100vh) rotate(360deg);
                opacity: 0;
            }
        }

        .timer {
            font-size: 2em;
            font-weight: bold;
            color: #FF0000;
            text-align: center;
            margin-bottom: 10px;
        }

        .timer.warning {
            color: #dc3545;
            animation: pulse 0.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .number-question {
            text-align: center;
            font-size: 2.5em;
            font-weight: bold;
            color: #FF0000;
            padding: 40px;
            margin-bottom: 30px;
            background: #f8f9fa;
            border-radius: 15px;
            border: 3px solid #FF0000;
            width: 100%;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .options-grid {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin: 0 auto;
            width: 100%;
        }

        .options-grid .item {
            margin-bottom: 0;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
        }

        .speaker-btn {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            padding: 5px 10px;
            transition: transform 0.2s ease;
            vertical-align: middle;
            margin-left: 15px;
        }

        .speaker-btn:hover {
            transform: scale(1.2);
            background: none;
            box-shadow: none;
        }

        .speaker-btn:active {
            transform: scale(1.1);
        }

        .verb-title-container {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 30px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="gameSelection" style="display: block;">
            <h1>üá®üá≠ Swiss German Practice</h1>
            <div class="subtitle">Choose a game to practice</div>
            <div style="text-align: center; color: #999; font-size: 0.9em; margin-top: 5px;">v1.3</div>

            <div style="text-align: center; color: #666; font-size: 0.85em; margin-top: 10px; font-style: italic;">
                üîä Audio pronunciation available (Standard German)
            </div>

            <div style="display: flex; gap: 20px; justify-content: center; margin-top: 30px; flex-wrap: wrap;">
                <button onclick="selectGameType('verbs')" style="font-size: 1.2em; padding: 20px 40px;">
                    üìù Verbs<br><span style="font-size: 0.8em; opacity: 0.8;">Match conjugations</span>
                </button>
                <button onclick="selectGameType('numbers')" style="font-size: 1.2em; padding: 20px 40px;">
                    üî¢ Numbers<br><span style="font-size: 0.8em; opacity: 0.8;">0-1000</span>
                </button>
                <button onclick="selectGameType('quiz')" style="font-size: 1.2em; padding: 20px 40px;">
                    üéì Quiz<br><span style="font-size: 0.8em; opacity: 0.8;">Test your knowledge</span>
                </button>
            </div>
        </div>

        <h1 id="gameTitle" style="display: none;">üá®üá≠ Swiss German</h1>
        <div id="gameSubtitle" class="subtitle" style="display: none;"></div>

        <div id="loading" class="loading" style="display: none;">Loading...</div>

        <div id="game" style="display: none;">
            <div class="mode-selector">
                <button class="mode-btn active" onclick="setMode('practice')">Practice üéØ</button>
                <button class="mode-btn" onclick="setMode('timed')">Timed ‚è±Ô∏è</button>
                <button class="mode-btn" onclick="setMode('streak')">Streak üî•</button>
            </div>

            <div id="timerDisplay" class="timer" style="display: none;"></div>

            <div class="stats">
                <div class="stat-box">
                    <div class="stat-label">Score</div>
                    <div class="stat-value"><span id="score">0</span>/<span id="total">0</span></div>
                </div>
                <div class="stat-box" id="streakBox">
                    <div class="stat-label">Streak üî•</div>
                    <div class="stat-value" id="streak">0</div>
                </div>
                <div class="stat-box" id="bestStreakBox">
                    <div class="stat-label">Best Streak ‚≠ê</div>
                    <div class="stat-value" id="bestStreak">0</div>
                </div>
            </div>

            <div class="verb-title-container">
                <div class="verb-title" id="questionTitle"></div>
                <button class="speaker-btn" id="speakerBtn" onclick="speakText()" style="display: none;" title="Listen to pronunciation (Standard German)">üîä</button>
            </div>

            <div class="game-container">
                <div class="column">
                    <h2 id="leftColumnTitle">Left</h2>
                    <div id="leftColumn"></div>
                </div>

                <div class="column">
                    <h2 id="rightColumnTitle">Right</h2>
                    <div id="rightColumn"></div>
                </div>
            </div>

            <div class="message" id="message"></div>

            <div class="controls">
                <button onclick="nextQuestion()">Next</button>
                <button onclick="resetGame()">Reset Score</button>
                <button onclick="backToMenu()">Back to Menu</button>
            </div>
        </div>
    </div>

    <script>
        // Game type
        let gameType = null; // 'verbs' or 'numbers'

        // Verb data structure
        let verbs = [];
        let verbDeck = []; // Shuffled deck of verbs
        let verbDeckIndex = 0; // Current position in deck
        let currentVerb = null;
        let selectedPronoun = null;
        let selectedConjugationId = null;
        let matchedPronouns = new Set();
        let matchedConjugationIds = new Set();
        let score = 0;
        let totalAttempts = 0;
        let conjugationIdCounter = 0;
        let currentStreak = 0;
        let bestStreak = 0;
        let gameMode = 'practice';
        let timer = null;
        let timeLeft = 60;
        let selectedPronounIndices = [];

        // Numbers game
        let currentNumber = null;
        let currentNumberOptions = [];
        let selectedRightId = null;
        let matchedRightIds = new Set();
        let numberGameMode = 'number-to-text'; // alternates between 'number-to-text' and 'text-to-number'

        // Quiz game
        let quizQuestions = [];
        let quizDeck = []; // Shuffled deck of quiz questions
        let quizDeckIndex = 0; // Current position in deck
        let currentQuizQuestion = null;
        let quizAnswered = false;

        // Swiss German pronouns
        const pronouns = ['ich', 'du', 'er/si/es', 'mir', 'ihr', 'Si'];

        // Text-to-Speech variables
        let currentTextToSpeak = '';
        let speechSynthesis = window.speechSynthesis;
        let germanVoice = null;

        // Initialize TTS on page load
        function initializeTTS() {
            if ('speechSynthesis' in window) {
                // Wait for voices to load
                speechSynthesis.onvoiceschanged = () => {
                    const voices = speechSynthesis.getVoices();
                    // Try to find a German voice (preferably de-DE, de-CH, or de-AT)
                    germanVoice = voices.find(voice => voice.lang.startsWith('de-')) || voices[0];
                };
            }
        }

        // Speak text using TTS
        function speakText(text) {
            if (!('speechSynthesis' in window)) {
                alert('Sorry, your browser does not support text-to-speech.');
                return;
            }

            // If text is provided, use it; otherwise use currentTextToSpeak
            const textToSpeak = text || currentTextToSpeak;
            if (!textToSpeak) return;

            // Cancel any ongoing speech
            speechSynthesis.cancel();

            // Extract just the verb (remove parenthetical translations)
            const cleanText = textToSpeak.split('(')[0].trim();

            const utterance = new SpeechSynthesisUtterance(cleanText);
            utterance.lang = 'de-DE'; // German
            utterance.rate = 0.85; // Slightly slower for learning
            utterance.pitch = 1.0;

            if (germanVoice) {
                utterance.voice = germanVoice;
            }

            speechSynthesis.speak(utterance);
        }

        // Initialize TTS when page loads
        initializeTTS();

        // Swiss German number words (based on course material PDF)
        function numberToSwissGerman(num) {
            // Standalone forms (0-9)
            const ones = ['null', 'eis', 'zw√§i', 'dr√º√º', 'vier', 'foif', 's√§chs', 'sibe', 'acht', 'n√º√ºn'];
            // Compound forms (for 21-29, 31-39, etc.)
            const onesCompound = ['', 'aine', 'zw√§ie', 'dr√º√ºe', 'viere', 'fuufe', 's√§chse', 'sibene', 'achte', 'n√º√ºne'];
            // Teens (10-19)
            const teens = ['z√§√§', 'elf', 'zw√∂lf', 'dr√º√ºz√§√§', 'vierz√§√§', 'f√ºfz√§√§', 's√§chz√§√§', 'sibz√§√§', 'achtz√§√§', 'n√º√ºnz√§√§'];
            // Tens (20, 30, 40, etc.)
            const tens = ['', '', 'zwanzg', 'drisg', 'vierzg', 'f√ºfzg', 's√§chzg', 'sibzg', 'achtzg', 'n√º√ºnzg'];
            // Hundreds
            const hundredsPrefix = ['', 'hundert', 'zw√§ihundert', 'dr√º√ºhundert', 'vierzchundert', 'foifhundert', 's√§chshundert', 'sibehundert', 'achthundert', 'n√º√ºnhundert'];

            if (num === 0) return 'null';
            if (num === 1000) return 'tuusig';

            let result = '';

            // Hundreds
            if (num >= 100) {
                const hundreds = Math.floor(num / 100);
                result += hundredsPrefix[hundreds];
                num %= 100;
            }

            // Tens and ones
            if (num >= 20) {
                const onesDigit = num % 10;
                const tensDigit = Math.floor(num / 10);
                if (onesDigit > 0) {
                    result += onesCompound[onesDigit] + tens[tensDigit];
                } else {
                    result += tens[tensDigit];
                }
            } else if (num >= 10) {
                result += teens[num - 10];
            } else if (num > 0) {
                result += ones[num];
            }

            return result;
        }

        // Generate wrong answers for numbers
        function generateWrongAnswers(correctNum, correctText) {
            const wrong = [];

            // Add nearby numbers
            const nearby = [correctNum - 1, correctNum + 1, correctNum - 10, correctNum + 10, correctNum + 100, correctNum - 100];
            for (let n of nearby) {
                if (n >= 0 && n <= 1000 && n !== correctNum) {
                    const wrongText = numberToSwissGerman(n);
                    if (!wrong.includes(wrongText)) {
                        wrong.push(wrongText);
                    }
                }
                if (wrong.length >= 3) break;
            }

            // If we need more, add some random numbers
            while (wrong.length < 3) {
                const random = Math.floor(Math.random() * 1001);
                if (random !== correctNum) {
                    const wrongText = numberToSwissGerman(random);
                    if (!wrong.includes(wrongText)) {
                        wrong.push(wrongText);
                    }
                }
            }

            return wrong.slice(0, 3);
        }

        // Funny feedback messages
        const correctMessages = [
            "Bravo! üéâ", "Super! üåü", "G√©nial! üéä", "Exactement! ‚ú®",
            "Parfait! üéØ", "Wunderbar! üèîÔ∏è", "Richtig! üí™",
            "Toll gemacht! üé®", "Fantastisch! üöÄ", "Hopp Schwiiz! üá®üá≠"
        ];

        const incorrectMessages = [
            "Oops! Versuech's nomol üòÖ", "N√∂d ganz... probier nomol! üí≠",
            "Fast! Encore un essai! üéØ", "Pas tout √† fait... allez! ü§î",
            "Hmm... nope! ü§∑", "N√§√§, das isch n√∂d richtig! üò¨",
            "Presque! Try again! üí°", "Schade! Next time! üé≤"
        ];

        const streakMessages = [
            "üî• En feu!", "‚ö° Incroyable!", "üí• Unstoppable!",
            "üåü T'es chaud!", "üéØ In the zone!", "üöÄ Sur la lanc√©e!"
        ];

        const completionMessages = [
            "Hopp Schwiiz! All matched! üá®üá≠üéâ",
            "Perfekt! Du bisch super! üèîÔ∏è‚ú®",
            "Bravo! C'est parfait! üéä",
            "Wunderbar! Tu es champion! üèÜ"
        ];

        // Game selection
        function selectGameType(type) {
            gameType = type;
            document.getElementById('gameSelection').style.display = 'none';
            document.getElementById('gameTitle').style.display = 'block';
            document.getElementById('gameSubtitle').style.display = 'block';
            document.getElementById('loading').style.display = 'block';

            if (type === 'verbs') {
                document.getElementById('gameSubtitle').textContent = 'Match the pronouns with their conjugations';
                document.getElementById('leftColumnTitle').textContent = 'Pronouns';
                document.getElementById('rightColumnTitle').textContent = 'Conjugations';
                loadVerbs();
            } else if (type === 'numbers') {
                document.getElementById('gameSubtitle').textContent = 'Match numbers with their Swiss German text';
                document.getElementById('leftColumnTitle').textContent = 'Number';
                document.getElementById('rightColumnTitle').textContent = 'Swiss German';
                loadNumbers();
            } else if (type === 'quiz') {
                document.getElementById('gameSubtitle').textContent = 'Test your Swiss German knowledge';
                document.getElementById('leftColumnTitle').textContent = '';
                document.getElementById('rightColumnTitle').textContent = '';
                loadQuiz();
            }
        }

        // Generic next question
        function nextQuestion() {
            if (gameType === 'verbs') {
                nextVerb();
            } else if (gameType === 'numbers') {
                nextNumber();
            } else if (gameType === 'quiz') {
                nextQuiz();
            }
        }

        // Back to menu
        function backToMenu() {
            document.getElementById('game').style.display = 'none';
            document.getElementById('gameTitle').style.display = 'none';
            document.getElementById('gameSubtitle').style.display = 'none';
            document.getElementById('gameSelection').style.display = 'block';

            // Reset scores
            score = 0;
            totalAttempts = 0;
            currentStreak = 0;
            bestStreak = 0;
            updateScore();
            updateStreak();

            // Reset decks
            verbDeckIndex = 0;
            quizDeckIndex = 0;
        }

        // Initialize verb deck (shuffle all verbs)
        function initializeVerbDeck() {
            verbDeck = shuffle([...verbs]);
            verbDeckIndex = 0;
        }

        // Load verbs from JSON file
        async function loadVerbs() {
            try {
                const response = await fetch('data/verbs.json');
                verbs = await response.json();
                initializeVerbDeck(); // Initialize the deck
                document.getElementById('loading').style.display = 'none';
                document.getElementById('game').style.display = 'block';
                nextVerb();
            } catch (error) {
                document.getElementById('loading').innerHTML =
                    'Error loading verbs. Please make sure data/verbs.json exists.';
                console.error('Error loading verbs:', error);
            }
        }

        // Load numbers game (no file needed, generated on the fly)
        function loadNumbers() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('game').style.display = 'block';
            nextNumber();
        }

        // Initialize quiz deck (shuffle all questions)
        function initializeQuizDeck() {
            quizDeck = shuffle([...quizQuestions]);
            quizDeckIndex = 0;
        }

        // Load quiz from JSON file
        async function loadQuiz() {
            try {
                const response = await fetch('data/quiz.json');
                quizQuestions = await response.json();
                initializeQuizDeck(); // Initialize the deck
                document.getElementById('loading').style.display = 'none';
                document.getElementById('game').style.display = 'block';
                nextQuiz();
            } catch (error) {
                document.getElementById('loading').innerHTML =
                    'Error loading quiz. Please make sure data/quiz.json exists.';
                console.error('Error loading quiz:', error);
            }
        }

        // Shuffle array
        function shuffle(array) {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }

        // Select next verb from deck (no immediate repeats)
        function nextVerb() {
            if (verbs.length === 0) return;

            // If we've gone through all verbs, reshuffle the deck
            if (verbDeckIndex >= verbDeck.length) {
                initializeVerbDeck();
                console.log('üîÑ Reshuffled verb deck - all verbs seen!');
            }

            // Take the next verb from the deck
            currentVerb = verbDeck[verbDeckIndex];
            verbDeckIndex++;

            matchedPronouns.clear();
            matchedConjugationIds.clear();
            selectedPronoun = null;
            selectedConjugationId = null;
            conjugationIdCounter = 0;

            // Randomly select 3-4 pronouns
            const numPronouns = Math.floor(Math.random() * 2) + 3; // 3 or 4
            const allIndices = [0, 1, 2, 3, 4, 5];
            selectedPronounIndices = shuffle(allIndices).slice(0, numPronouns).sort((a, b) => a - b);

            document.getElementById('questionTitle').textContent = currentVerb.infinitive;
            document.getElementById('message').textContent = '';
            document.getElementById('message').className = 'message';

            // Show speaker button and set text for pronunciation
            const speakerBtn = document.getElementById('speakerBtn');
            if (speakerBtn && 'speechSynthesis' in window) {
                speakerBtn.style.display = 'inline-block';
                currentTextToSpeak = currentVerb.infinitive;
            }

            renderPronouns();
            renderConjugations();
        }

        // Select next random number
        function nextNumber() {
            // Alternate between number-to-text and text-to-number
            numberGameMode = (numberGameMode === 'number-to-text') ? 'text-to-number' : 'number-to-text';

            // Generate random number between 0-1000
            currentNumber = Math.floor(Math.random() * 1001);
            const correctText = numberToSwissGerman(currentNumber);

            if (numberGameMode === 'number-to-text') {
                // Mode: Show number, choose text
                const wrongTexts = generateWrongAnswers(currentNumber, correctText);
                currentNumberOptions = shuffle([
                    { text: correctText, correct: true, id: 0 },
                    ...wrongTexts.map((text, i) => ({ text, correct: false, id: i + 1 }))
                ]);
                document.getElementById('leftColumnTitle').textContent = 'Number';
                document.getElementById('rightColumnTitle').textContent = 'Swiss German';
            } else {
                // Mode: Show text, choose number
                const wrongNumbers = generateWrongNumbers(currentNumber);
                currentNumberOptions = shuffle([
                    { text: currentNumber.toString(), correct: true, id: 0 },
                    ...wrongNumbers.map((num, i) => ({ text: num.toString(), correct: false, id: i + 1 }))
                ]);
                document.getElementById('leftColumnTitle').textContent = 'Swiss German';
                document.getElementById('rightColumnTitle').textContent = 'Number';
            }

            matchedRightIds.clear();
            selectedRightId = null;

            document.getElementById('questionTitle').textContent = '';
            document.getElementById('message').textContent = '';
            document.getElementById('message').className = 'message';

            // Hide main speaker button (numbers game has its own inline)
            const speakerBtn = document.getElementById('speakerBtn');
            if (speakerBtn) {
                speakerBtn.style.display = 'none';
            }

            renderNumberGame();
        }

        // Select next quiz question from deck (no immediate repeats)
        function nextQuiz() {
            if (quizQuestions.length === 0) return;

            // If we've gone through all questions, reshuffle the deck
            if (quizDeckIndex >= quizDeck.length) {
                initializeQuizDeck();
                console.log('üîÑ Reshuffled quiz deck - all questions seen!');
            }

            // Take the next question from the deck
            currentQuizQuestion = quizDeck[quizDeckIndex];
            quizDeckIndex++;
            quizAnswered = false;

            document.getElementById('questionTitle').textContent = currentQuizQuestion.question;
            document.getElementById('message').textContent = '';
            document.getElementById('message').className = 'message';

            // Hide speaker button for quiz (questions are too long)
            const speakerBtn = document.getElementById('speakerBtn');
            if (speakerBtn) {
                speakerBtn.style.display = 'none';
            }

            renderQuiz();
        }

        // Generate wrong number options
        function generateWrongNumbers(correctNum) {
            const wrong = [];
            const variations = [
                correctNum + 1, correctNum - 1,
                correctNum + 10, correctNum - 10,
                correctNum + 100, correctNum - 100,
                Math.floor(correctNum / 10) * 10 + ((correctNum % 10 + 5) % 10), // swap last digit
                correctNum * 2, Math.floor(correctNum / 2)
            ];

            for (let n of variations) {
                if (n >= 0 && n <= 1000 && n !== correctNum && !wrong.includes(n)) {
                    wrong.push(n);
                }
                if (wrong.length >= 3) break;
            }

            // Make sure we have exactly 3 wrong answers
            while (wrong.length < 3) {
                const random = Math.floor(Math.random() * 1001);
                if (random !== correctNum && !wrong.includes(random)) {
                    wrong.push(random);
                }
            }

            return wrong.slice(0, 3);
        }

        // Render pronouns column
        function renderPronouns() {
            const container = document.getElementById('leftColumn');
            const gameContainer = document.querySelector('.game-container');

            container.style.display = 'block'; // Ensure visible
            container.style.width = '';
            container.style.maxWidth = '300px';
            container.style.flex = '';
            container.classList.remove('full-width');

            // Restore flex layout for columns
            gameContainer.style.display = 'flex';
            gameContainer.style.maxWidth = '';
            gameContainer.style.margin = '';

            // Show column titles
            document.getElementById('leftColumnTitle').style.display = 'block';
            document.getElementById('rightColumnTitle').style.display = 'block';

            // Hide quiz and numbers containers if they exist
            const quizContainer = document.getElementById('quiz-container');
            if (quizContainer) quizContainer.style.display = 'none';
            const numbersContainer = document.getElementById('numbers-container');
            if (numbersContainer) numbersContainer.style.display = 'none';

            container.innerHTML = selectedPronounIndices.map(index => `
                <div class="item ${matchedPronouns.has(index) ? 'matched' : ''}"
                     onclick="selectPronoun(${index})"
                     id="pronoun-${index}">
                    ${pronouns[index]}
                </div>
            `).join('');
        }

        // Render conjugations column (shuffled)
        function renderConjugations() {
            const container = document.getElementById('rightColumn');
            container.style.display = 'block'; // Ensure visible
            container.style.width = '';
            container.style.maxWidth = '300px';
            container.style.margin = '';

            // Only show conjugations for selected pronouns
            const filteredConjugations = selectedPronounIndices.map(index => {
                const uniqueId = conjugationIdCounter++;
                return {conj: currentVerb.conjugations[index], index, uniqueId};
            });
            const shuffled = shuffle(filteredConjugations);

            container.innerHTML = shuffled.map(({conj, index, uniqueId}) => `
                <div class="item ${matchedConjugationIds.has(uniqueId) ? 'matched' : ''}"
                     onclick="selectConjugation(${uniqueId}, ${index})"
                     id="conjugation-${uniqueId}"
                     data-original-index="${index}"
                     data-unique-id="${uniqueId}">
                    ${conj}
                </div>
            `).join('');
        }

        // Render numbers game
        function renderNumberGame() {
            const leftContainer = document.getElementById('leftColumn');
            const rightContainer = document.getElementById('rightColumn');
            const gameContainer = document.querySelector('.game-container');

            // Hide column titles for numbers game
            document.getElementById('leftColumnTitle').style.display = 'none';
            document.getElementById('rightColumnTitle').style.display = 'none';

            // Hide both column containers completely
            leftContainer.style.display = 'none';
            rightContainer.style.display = 'none';

            // Hide quiz container if it exists
            const quizContainer = document.getElementById('quiz-container');
            if (quizContainer) quizContainer.style.display = 'none';

            // Adjust game-container to block layout taking full width
            gameContainer.style.display = 'block';
            gameContainer.style.maxWidth = '100%';
            gameContainer.style.margin = '0 auto';

            let questionContent;
            if (numberGameMode === 'number-to-text') {
                questionContent = currentNumber;
            } else {
                questionContent = numberToSwissGerman(currentNumber);
            }

            // Create or get numbers container
            let numbersContainer = document.getElementById('numbers-container');
            if (!numbersContainer) {
                numbersContainer = document.createElement('div');
                numbersContainer.id = 'numbers-container';
                gameContainer.appendChild(numbersContainer);
            }
            numbersContainer.style.display = 'block';
            numbersContainer.style.width = '100%';

            // Set text for pronunciation
            currentTextToSpeak = questionContent.toString();

            // Display question on top, options below vertically
            numbersContainer.innerHTML = `
                <div class="verb-title-container">
                    <div class="number-question" id="number-question" style="margin-bottom: 0;">
                        ${questionContent}
                    </div>
                    <button class="speaker-btn" onclick="speakText()" title="Listen to pronunciation (Standard German)">üîä</button>
                </div>
                <div class="options-grid" style="margin-top: 30px;">
                    ${currentNumberOptions.map(option => `
                        <div class="item ${matchedRightIds.has(option.id) ? 'matched' : ''}"
                             onclick="selectNumberRight(${option.id}, ${option.correct})"
                             id="number-right-${option.id}">
                            ${option.text}
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // Render quiz game
        function renderQuiz() {
            const leftContainer = document.getElementById('leftColumn');
            const rightContainer = document.getElementById('rightColumn');
            const gameContainer = document.querySelector('.game-container');

            // Hide both columns
            leftContainer.innerHTML = '';
            leftContainer.style.display = 'none';
            rightContainer.innerHTML = '';
            rightContainer.style.display = 'none';

            // Hide column titles
            document.getElementById('leftColumnTitle').style.display = 'none';
            document.getElementById('rightColumnTitle').style.display = 'none';

            // Adjust game-container to not use flex columns
            gameContainer.style.display = 'block';
            gameContainer.style.maxWidth = '800px';
            gameContainer.style.margin = '0 auto';

            // Create quiz container if it doesn't exist
            let quizContainer = document.getElementById('quiz-container');
            if (!quizContainer) {
                quizContainer = document.createElement('div');
                quizContainer.id = 'quiz-container';
                gameContainer.appendChild(quizContainer);
            }
            quizContainer.style.display = 'block';
            quizContainer.style.width = '100%';

            quizContainer.innerHTML = currentQuizQuestion.options.map((option, index) => `
                <div class="item ${quizAnswered ? (index === currentQuizQuestion.correct ? 'correct' : '') : ''}"
                     onclick="selectQuizAnswer(${index})"
                     id="quiz-option-${index}"
                     style="cursor: ${quizAnswered ? 'default' : 'pointer'}; margin-bottom: 15px; padding: 20px;">
                    ${option}
                </div>
            `).join('');

            // Show explanation if answered
            if (quizAnswered) {
                quizContainer.innerHTML += `
                    <div style="margin-top: 30px; padding: 20px; background: #f0f8ff; border-radius: 10px; border: 2px solid #4a90e2;">
                        <strong style="color: #2c5282;">üí° Explanation:</strong><br>
                        ${currentQuizQuestion.explanation}
                    </div>
                `;
            }
        }

        // Handle quiz answer selection
        function selectQuizAnswer(selectedIndex) {
            if (quizAnswered) return; // Already answered

            quizAnswered = true;
            totalAttempts++;

            if (selectedIndex === currentQuizQuestion.correct) {
                // Correct!
                score++;
                currentStreak++;
                if (currentStreak > bestStreak) {
                    bestStreak = currentStreak;
                }
                updateStreak();
                showMessage(getRandomMessage(correctMessages), 'success');
            } else {
                // Incorrect
                currentStreak = 0;
                updateStreak();
                showMessage(getRandomMessage(incorrectMessages), 'error');
            }

            updateScore();
            renderQuiz(); // Re-render to show explanation

            // Auto-advance after showing explanation
            setTimeout(() => {
                nextQuiz();
            }, 3000);
        }

        // Handle pronoun selection
        function selectPronoun(index) {
            if (matchedPronouns.has(index)) return;

            // Clear previous selection
            if (selectedPronoun !== null) {
                document.getElementById(`pronoun-${selectedPronoun}`).classList.remove('selected');
            }

            selectedPronoun = index;
            document.getElementById(`pronoun-${index}`).classList.add('selected');

            checkMatch();
        }

        // Handle conjugation selection
        function selectConjugation(uniqueId, originalIndex) {
            if (matchedConjugationIds.has(uniqueId)) return;

            // Clear previous selection
            document.querySelectorAll('#rightColumn .item').forEach(el => {
                el.classList.remove('selected');
            });

            selectedConjugationId = uniqueId;
            document.getElementById(`conjugation-${uniqueId}`).classList.add('selected');

            checkMatch();
        }

        // Handle number right selection (directly check answer)
        function selectNumberRight(id, isCorrect) {
            if (matchedRightIds.has(id)) return;

            const rightEl = document.getElementById(`number-right-${id}`);
            const questionEl = document.getElementById('number-question');

            if (isCorrect) {
                // Correct!
                rightEl.classList.add('correct');
                questionEl.classList.add('correct');

                matchedRightIds.add(id);
                score++;
                totalAttempts++;
                currentStreak++;

                if (currentStreak > bestStreak) {
                    bestStreak = currentStreak;
                }
                updateStreak();

                showMessage(getRandomMessage(correctMessages), 'success');

                setTimeout(() => {
                    nextNumber();
                }, 1000);

            } else {
                // Incorrect
                rightEl.classList.add('incorrect');
                totalAttempts++;
                currentStreak = 0;
                updateStreak();

                showMessage(getRandomMessage(incorrectMessages), 'error');

                setTimeout(() => {
                    rightEl.classList.remove('incorrect');
                }, 500);
            }

            updateScore();
        }

        // Check if selections match
        function checkMatch() {
            if (selectedPronoun === null || selectedConjugationId === null) return;

            const pronounEl = document.getElementById(`pronoun-${selectedPronoun}`);
            const conjugationEl = document.getElementById(`conjugation-${selectedConjugationId}`);

            // Get the expected conjugation for the selected pronoun
            const expectedConjugation = currentVerb.conjugations[selectedPronoun];

            // Get the actual conjugation text that was clicked
            const selectedConjugationText = conjugationEl.textContent.trim();

            // Check if they match by comparing the text
            if (expectedConjugation === selectedConjugationText) {
                // Correct match!
                pronounEl.classList.remove('selected');
                pronounEl.classList.add('correct');
                conjugationEl.classList.remove('selected');
                conjugationEl.classList.add('correct');

                matchedPronouns.add(selectedPronoun);
                matchedConjugationIds.add(selectedConjugationId);
                score++;
                totalAttempts++;
                currentStreak++;

                if (currentStreak > bestStreak) {
                    bestStreak = currentStreak;
                }
                updateStreak();

                showMessage(getRandomMessage(correctMessages), 'success');

                setTimeout(() => {
                    pronounEl.classList.remove('correct');
                    conjugationEl.classList.remove('correct');
                    renderPronouns();
                    renderConjugations();

                    if (matchedPronouns.size === selectedPronounIndices.length) {
                        showMessage(getRandomMessage(completionMessages), 'success');

                        if (gameMode === 'timed') {
                            timeLeft += 10; // Bonus time
                        }

                        // Auto-advance to next verb after completion
                        setTimeout(() => {
                            nextVerb();
                        }, 1000);
                    }
                }, 500);

            } else {
                // Incorrect match
                pronounEl.classList.add('incorrect');
                conjugationEl.classList.add('incorrect');
                totalAttempts++;
                currentStreak = 0;
                updateStreak();

                showMessage(getRandomMessage(incorrectMessages), 'error');

                setTimeout(() => {
                    pronounEl.classList.remove('selected', 'incorrect');
                    conjugationEl.classList.remove('selected', 'incorrect');
                }, 500);
            }

            selectedPronoun = null;
            selectedConjugationId = null;
            updateScore();
        }

        // Show message
        function showMessage(text, type) {
            const messageEl = document.getElementById('message');
            messageEl.textContent = text;
            messageEl.className = `message ${type}`;

            setTimeout(() => {
                messageEl.textContent = '';
                messageEl.className = 'message';
            }, 2000);
        }

        // Update score display
        function updateScore() {
            document.getElementById('score').textContent = score;
            document.getElementById('total').textContent = totalAttempts;
        }

        // Reset game
        function resetGame() {
            score = 0;
            totalAttempts = 0;
            currentStreak = 0;
            bestStreak = 0;
            updateScore();
            updateStreak();

            // Reshuffle decks for a fresh start
            if (gameType === 'verbs' && verbs.length > 0) {
                initializeVerbDeck();
            } else if (gameType === 'quiz' && quizQuestions.length > 0) {
                initializeQuizDeck();
            }

            if (gameMode === 'timed') {
                timeLeft = 60;
                if (timer) clearInterval(timer);
                startTimer();
            }

            nextQuestion();
        }

        // Set game mode
        function setMode(mode) {
            gameMode = mode;
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            // Reshuffle decks when changing modes for variety
            if (gameType === 'verbs' && verbs.length > 0) {
                initializeVerbDeck();
            } else if (gameType === 'quiz' && quizQuestions.length > 0) {
                initializeQuizDeck();
            }

            if (mode === 'timed') {
                timeLeft = 60;
                document.getElementById('timerDisplay').style.display = 'block';
                startTimer();
            } else {
                document.getElementById('timerDisplay').style.display = 'none';
                if (timer) clearInterval(timer);
            }

            if (mode === 'streak') {
                currentStreak = 0;
                updateStreak();
            }

            nextQuestion();
        }

        // Timer functions
        function startTimer() {
            if (timer) clearInterval(timer);
            updateTimerDisplay();

            timer = setInterval(() => {
                timeLeft--;
                updateTimerDisplay();

                if (timeLeft <= 0) {
                    clearInterval(timer);
                    showMessage('‚è∞ Time\'s up! Score: ' + score, 'error');
                    setTimeout(() => {
                        timeLeft = 60;
                        score = 0;
                        totalAttempts = 0;
                        updateScore();
                        startTimer();
                        nextQuestion();
                    }, 2000);
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const display = document.getElementById('timerDisplay');
            display.textContent = '‚è±Ô∏è ' + timeLeft + 's';
            display.className = timeLeft <= 10 ? 'timer warning' : 'timer';
        }

        // Streak functions
        function updateStreak() {
            document.getElementById('streak').textContent = currentStreak;
            document.getElementById('bestStreak').textContent = bestStreak;

            if (currentStreak > 0 && currentStreak % 5 === 0) {
                const msg = streakMessages[Math.floor(Math.random() * streakMessages.length)];
                showMessage(msg + ' ' + currentStreak + ' streak!', 'success');
            }
        }

        // Confetti animation
        function createConfetti() {
            const emojis = ['üéâ', 'üéä', '‚≠ê', '‚ú®', 'üèîÔ∏è', 'üá®üá≠', 'üí´', 'üåü'];
            for (let i = 0; i < 20; i++) {
                setTimeout(() => {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    confetti.textContent = emojis[Math.floor(Math.random() * emojis.length)];
                    confetti.style.left = Math.random() * 100 + '%';
                    confetti.style.animationDuration = (Math.random() * 2 + 2) + 's';
                    document.body.appendChild(confetti);

                    setTimeout(() => confetti.remove(), 3000);
                }, i * 50);
            }
        }

        // Random message selector
        function getRandomMessage(array) {
            return array[Math.floor(Math.random() * array.length)];
        }

        // Initialize - show game selection screen (no auto-load)
    </script>
</body>
</html>
